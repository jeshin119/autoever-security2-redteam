FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive

# ğŸ”‘ Use default Ubuntu repositories which support multi-architecture
RUN for i in 1 2 3; do \
        apt-get update && \
        apt-get install -y --fix-missing \
            curl \
            sudo \
            python3 \
            build-essential && \
        break || sleep 10; \
    done && \
    rm -rf /var/lib/apt/lists/*

RUN useradd -m server && \
    echo "server:123456" | chpasswd && \
    echo 'server ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

USER server
WORKDIR /home/server/app

ENV NODE_VERSION=10.13.0
ENV NVM_DIR=/home/server/.nvm
RUN mkdir -p $NVM_DIR && \
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
ENV NODE_PATH=$NVM_DIR/versions/node/v$NODE_VERSION/lib/node_modules
ENV PATH=$NVM_DIR/versions/node/v$NODE_VERSION/bin:$PATH

RUN bash -c "source $NVM_DIR/nvm.sh && \
    nvm install $NODE_VERSION && \
    nvm alias default $NODE_VERSION && \
    nvm use default"

# rootë¡œ ë‹¤ì‹œ ì „í™˜í•˜ì—¬ ê¶Œí•œ ì„¤ì •
USER root
# package.jsonê³¼ package-lock.jsonì„ ë¨¼ì € ë³µì‚¬
COPY --chown=server:server package*.json ./

# ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì • (root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰)
RUN chown -R server:server /home/server/app
RUN chmod -R 755 /home/server/app

# server ì‚¬ìš©ìë¡œ npm install ì‹¤í–‰
USER server
RUN npm install

# rootë¡œ ë‹¤ì‹œ ì „í™˜í•˜ì—¬ íŒŒì¼ ë³µì‚¬
USER root
# ë‚˜ë¨¸ì§€ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (.dockerignoreì— ì˜í•´ node_modulesëŠ” ì œì™¸ë¨)
COPY --chown=server:server . .

# server ì‚¬ìš©ìë¡œ ë‹¤ì‹œ ì „í™˜
USER server
RUN mkdir -p uploads logs
RUN chmod -R 755 uploads logs

EXPOSE 5000

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:5000/api/health || exit 1

CMD ["npm", "run", "dev"]
